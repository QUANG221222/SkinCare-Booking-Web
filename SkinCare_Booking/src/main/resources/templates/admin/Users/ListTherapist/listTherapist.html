<!doctype html>
<html lang="en" class="layout-menu-fixed layout-compact" data-assets-path="/admin/assets/" data-template="vertical-menu-template-free" xmlns:th="http://www.thymeleaf.org">
<!-- Head -->
<div th:replace="admin/fragments/head :: head"></div>

<body>
<!-- Layout wrapper -->
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <!-- Menu -->
        <div th:replace="admin/fragments/menu :: menu"></div>
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
            <!-- Navbar -->
            <nav class="layout-navbar container-xxl navbar-detached navbar navbar-expand-xl align-items-center bg-navbar-theme" id="layout-navbar">
                <div class="layout-menu-toggle navbar-nav align-items-xl-center me-4 me-xl-0 d-xl-none">
                    <a class="nav-item nav-link px-0 me-xl-6" href="javascript:void(0)">
                        <i class="icon-base bx bx-menu icon-md"></i>
                    </a>
                </div>

                <div class="navbar-nav-right d-flex align-items-center justify-content-end" id="navbar-collapse">
                    <ul class="navbar-nav flex-row align-items-center ms-md-auto">
                        <!-- User -->
                        <div th:replace="admin/fragments/user :: user"></div>
                        <!--/ User -->
                    </ul>
                </div>
            </nav>
            <!-- / Navbar -->

            <!-- Content wrapper -->
            <div class="content-wrapper">
                <!-- Content -->
                <div class="container-xxl flex-grow-1 container-p-y">
                    <!-- Users List Table -->
                    <div class="card">
                        <div th:if="${#strings.contains(currentURI, 'manager')}" class="row mx-3 my-0 justify-content-between">
                            <div class="py-3 d-flex align-items-center justify-content-between flex-wrap gap-3">
                                <button class="btn add-new btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAddUser">
                                    <i class="icon-base bx bx-plus icon-sm me-2"></i>
                                    <span>Add New User</span>
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <div th:if="${#strings.contains(currentURI, 'manager')}" class="container mt-3">
                                <!-- Alert for Success -->
                                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show position-relative" role="alert">
                                    <span th:text="${successMessage}"></span>
                                </div>

                                <!-- Alert for Error -->
                                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show position-relative" role="alert">
                                    <span th:text="${errorMessage}"></span>
                                </div>
                            </div>
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                <tr>
                                    <th style="width: 20%;">User</th>
                                    <th>Role</th>
                                    <th>Contact</th>
                                    <th>Address</th>
                                    <th>Specialty</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="therapistTable">
                                <tr th:each="therapist : ${therapistList}">
                                    <div th:replace="admin/Users/ListTherapist/Therapist/Therapist :: therapist"></div>
                                </tr>
                                <tr id="noTherapistRow" th:if="${#lists.isEmpty(therapistList)}">
                                    <td colspan="6" class="text-center">No therapists found.</td>
                                </tr>
                                </tbody>
                            </table>
                            <!-- Pagination -->
                            <div class="d-flex justify-content-center mt-3">
                                <nav aria-label="Page navigation">
                                    <ul class="pagination">
                                        <li class="page-item" id="prevPage">
                                            <a class="page-link" href="#" aria-label="Previous">
                                                <span aria-hidden="true">«</span>
                                            </a>
                                        </li>
                                        <li class="page-item active" id="page1"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item" id="nextPage">
                                            <a class="page-link" href="#" aria-label="Next">
                                                <span aria-hidden="true">»</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- Modals -->
                    <!-- Modal Confirm Delete Therapist -->
                    <div class="modal fade" id="deleteConfirmModal" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Are you sure you want to delete this therapist?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <a class="btn btn-danger" id="confirmDeleteButton">Delete</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Edit Information Therapist -->
                    <div class="modal fade" id="editTherapistModal" aria-labelledby="editTherapistModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editTherapistModalLabel">Edit Therapist Information</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editTherapistForm">
                                        <div class="mb-3">
                                            <label for="edit-user-username" class="form-label">Username</label>
                                            <input type="text" class="form-control" id="edit-user-username" name="username" placeholder="Enter username" required pattern="^[a-zA-Z0-9]{3,20}$" title="Username must be between 3 and 20 characters (letters and numbers only)" />
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit-user-fullname" class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="edit-user-fullname" name="fullName" placeholder="Enter full name" required minlength="2" maxlength="50" title="Full name must be between 2 and 50 characters" />
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit-user-img" class="form-label">Image URL</label>
                                            <input type="url" class="form-control" id="edit-user-img" name="img" placeholder="Enter image URL" required />
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit-user-email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="edit-user-email" name="email" placeholder="Enter email" required maxlength="50" pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$" title="Please enter a valid email address" />
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit-user-phone" class="form-label">Phone Number</label>
                                            <input type="text" class="form-control" id="edit-user-phone" name="phone" placeholder="Enter phone number" required pattern="^(\\+84|0)[1-9][0-9]{8}$" title="Invalid phone number. Example: 0987654321 or +84987654321" />
                                        </div>
                                        <div class="mb-3">
                                            <label for="location" class="form-label">Address</label>
                                            <input type="text" class="form-control" id="location" name="location" placeholder="Enter address" />
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit-user-specialty" class="form-label">Specialty</label>
                                            <input type="text" class="form-control" id="edit-user-specialty" name="specialty" placeholder="Enter specialty" required maxlength="100" title="Specialty must not exceed 100 characters" />
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-primary">Save Changes</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Add New Therapist -->
                    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasAddUser" aria-labelledby="offcanvasAddUserLabel">
                        <div class="offcanvas-header">
                          <h5 id="offcanvasAddUserLabel" class="offcanvas-title">Add New Staff</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
                        </div>
                        <div class="offcanvas-body">
                          <form th:action="@{/protected/manager/register-staff}" method="post">
                            <div class="mb-3">
                              <label for="add-user-username" class="form-label">Username</label>
                              <input
                                      type="text"
                                      class="form-control"
                                      id="add-user-username"
                                      name="username"
                                      placeholder="Enter username"
                                      required
                                      pattern="^[a-zA-Z0-9]{3,20}$"
                                      title="Username must be between 3 and 20 characters (letters and numbers only)"
                              />
                            </div>
                            <div class="mb-3">
                              <label for="add-user-fullname" class="form-label">Full Name</label>
                              <input
                                      type="text"
                                      class="form-control"
                                      id="add-user-fullname"
                                      name="fullname"
                                      placeholder="Enter full name"
                                      required
                                      minlength="2"
                                      maxlength="50"
                                      title="Full name must be between 2 and 50 characters"
                              />
                            </div>
                            <div class="mb-3">
                              <label for="add-user-img" class="form-label">Image URL</label>
                              <input
                                      type="url"
                                      class="form-control"
                                      id="add-user-img"
                                      name="img"
                                      placeholder="Enter image URL"
                                      required
                              />
                            </div>
                            <div class="mb-3">
                              <label for="add-user-email" class="form-label">Email</label>
                              <input
                                      type="email"
                                      class="form-control"
                                      id="add-user-email"
                                      name="email"
                                      placeholder="Enter email"
                                      required
                                      maxlength="50"
                                      pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
                                      title="Please enter a valid email address"
                              />
                            </div>
                            <div class="mb-3">
                              <label for="add-user-phone" class="form-label">Phone</label>
                              <input
                                      type="text"
            class="form-control"
                                      id="add-user-phone"
                                      name="phone"
                                      placeholder="Enter phone number"
                                      required
                                      pattern="^(\\+84|0)[1-9][0-9]{8}$"
                                      title="Invalid phone number format. Ex: 0987654321 or +84987654321"
                              />
                            </div>
                            <div class="mb-3">
                              <label for="password" class="form-label">Password</label>
                              <input
                                      type="password"
                                      class="form-control"
                                      id="password"
                                      name="password"
                                      placeholder="Enter password"
                                      pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@#$%^&+=!]).{6,40}$"
                                      title="Password must contain at least 1 uppercase letter, 1 lowercase letter, 1 number and 1 special character. Ex: Abc@123"
                                      required
                              />
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                            <button type="reset" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Modal View Schedule Therapist -->
                    <div class="modal fade" id="viewScheduleModal" aria-labelledby="viewScheduleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="viewScheduleModalLabel">Work Schedule of <span id="therapistName"></span></h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Success or error message -->
                                    <div id="scheduleSuccessMessage" class="alert alert-success alert-dismissible fade show d-none" role="alert">
                                        <span id="scheduleSuccessText"></span>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                    <div id="scheduleErrorMessage" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
                                        <span id="scheduleErrorText"></span>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>

                                    <!-- Schedule List -->
                                    <table class="table table-bordered table-hover" style="background-color: #f8f9fa;" id="scheduleTable">
                                        <thead>
                                        <tr style="background-color: #e9ecef;">
                                            <th>ID</th>
                                            <th>Day</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody id="scheduleTableBody">
                                        </tbody>
                                    </table>

                                    <!-- Create Schedule Form -->
                                    <div class="mt-4">
                                        <button type="button" class="btn btn-primary mb-3"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#createScheduleFormCollapse"
                                                aria-expanded="false"
                                                aria-controls="createScheduleFormCollapse">
                                            Create New Schedule
                                        </button>
                                        <div class="collapse" id="createScheduleFormCollapse">
                                            <form id="createScheduleForm">
                                                <input type="hidden" id="createTherapistId" name="therapistId"/>
                                                <div class="mb-3">
                                                    <label for="createScheduleDay" class="form-label">Day:</label>
                                                    <select class="form-control" id="createScheduleDay" name="dayOfWeek" required>
                                                        <option value="MONDAY">Monday</option>
                                                        <option value="TUESDAY">Tuesday</option>
                                                        <option value="WEDNESDAY">Wednesday</option>
                                                        <option value="THURSDAY">Thursday</option>
                                                        <option value="FRIDAY">Friday</option>
                                                        <option value="SATURDAY">Saturday</option>
                                                        <option value="SUNDAY">Sunday</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="createScheduleStartTime" class="form-label">Start Time:</label>
                                                    <input type="time" class="form-control" id="createScheduleStartTime" name="startTime" required />
                                                </div>
                                                <div class="mb-3">
                                                    <label for="createScheduleEndTime" class="form-label">End Time:</label>
                                                    <input type="time" class="form-control" id="createScheduleEndTime" name="endTime" required />
                                                </div>
                                                <button type="submit" class="btn btn-primary">Create Schedule</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Edit Schedule -->
                    <div class="modal fade" id="editScheduleModal" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editScheduleModalLabel">Edit Work Schedule</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editScheduleForm">
                                        <input type="hidden" id="editScheduleId" name="scheduleId"/>
                                        <input type="hidden" id="editTherapistId" name="therapistId"/>
                                        <div class="mb-3">
                                            <label for="editScheduleDay" class="form-label">Day:</label>
                                            <select class="form-control" id="editScheduleDay" name="dayOfWeek" required>
                                                <option value="MONDAY">Monday</option>
                                                <option value="TUESDAY">Tuesday</option>
                                                <option value="WEDNESDAY">Wednesday</option>
                                                <option value="THURSDAY">Thursday</option>
                                                <option value="FRIDAY">Friday</option>
                                                <option value="SATURDAY">Saturday</option>
                                                <option value="SUNDAY">Sunday</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editScheduleStartTime" class="form-label">Start Time:</label>
                                            <input type="time" class="form-control" id="editScheduleStartTime" name="startTime" required />
                                        </div>
                                        <div class="mb-3">
                                            <label for="editScheduleEndTime" class="form-label">End Time:</label>
                                            <input type="time" class="form-control" id="editScheduleEndTime" name="endTime" required />
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-primary">Update Schedule</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- / Content -->
            </div>
            <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>
    <!-- / Layout wrapper -->

    <!-- Core JS -->
    <div th:replace="admin/fragments/script :: script"></div>

    <!-- JavaScript for Pagination -->
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script>
        $(document).ready(function () {
            // Phân trang
            const therapistTable = $('#therapistTable');
            const therapistRows = therapistTable.find('tr').not('#noTherapistRow').get(); // Lấy tất cả hàng trừ hàng "No therapists found"

            if (therapistRows.length > 0) {
                const rowsPerPage = 10; // Số bác sĩ mỗi trang
                const totalRows = therapistRows.length;
                const totalPages = Math.ceil(totalRows / rowsPerPage);
                let currentPage = 1;

                // Tạo danh sách các trang trong pagination
                const pagination = $('.pagination');
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1) continue; // Bỏ qua page 1 vì đã có sẵn trong HTML
                    pagination.find('#nextPage').before(
                        `<li class="page-item" id="page${i}"><a class="page-link" href="#">${i}</a></li>`
                    );
                }

                // Hàm hiển thị bác sĩ theo trang
                function showPage(page) {
                    currentPage = page;
                    therapistTable.find('tr').not('#noTherapistRow').hide(); // Ẩn tất cả hàng

                    const start = (page - 1) * rowsPerPage;
                    const end = Math.min(start + rowsPerPage, totalRows);

                    for (let i = start; i < end; i++) {
                        $(therapistRows[i]).show(); // Hiển thị các hàng thuộc trang hiện tại
                    }

                    // Cập nhật trạng thái pagination
                    pagination.find('li').removeClass('active');
                    $(`#page${page}`).addClass('active');

                    // Cập nhật trạng thái nút Previous/Next
                    $('#prevPage').toggleClass('disabled', page === 1);
                    $('#nextPage').toggleClass('disabled', page === totalPages);
                }

                // Sự kiện chuyển trang
                pagination.on('click', 'a', function (e) {
                    e.preventDefault();
                    const pageItem = $(this).parent();
                    if (pageItem.hasClass('disabled')) return;

                    if (pageItem.attr('id') === 'prevPage') {
                        if (currentPage > 1) showPage(currentPage - 1);
                    } else if (pageItem.attr('id') === 'nextPage') {
                        if (currentPage < totalPages) showPage(currentPage + 1);
                    } else {
                        const page = parseInt($(this).text());
                        showPage(page);
                    }
                });

                // Hiển thị trang đầu tiên
                showPage(1);
            }

            // Xử lý nút Delete Therapist
            const deleteButtons = document.querySelectorAll(".delete-btn");
            deleteButtons.forEach((button) => {
                button.addEventListener("click", (event) => {
                    const id = event.currentTarget.getAttribute("data-id");
                    const confirmDeleteButton = document.getElementById("confirmDeleteButton");
                    confirmDeleteButton.setAttribute("href", `/protected/manager/delete-therapist/${id}`);
                });
            });

            // Xử lý nút Edit Therapist
            const editButtons = document.querySelectorAll(".edit-btn");
            editButtons.forEach((button) => {
                button.addEventListener("click", function (event) {
                    const editModal = document.querySelector("#editTherapistModal");
                    const id = event.currentTarget.getAttribute("data-id");
                    const username = event.currentTarget.getAttribute("data-username");
                    const fullName = event.currentTarget.getAttribute("data-fullname");
                    const img = event.currentTarget.getAttribute("data-img");
                    const email = event.currentTarget.getAttribute("data-email");
                    const phone = event.currentTarget.getAttribute("data-phone");
                    const location = event.currentTarget.getAttribute("data-location");
                    const specialty = event.currentTarget.getAttribute("data-specialty");

                    editModal.querySelector("#edit-user-username").value = username;
                    editModal.querySelector("#edit-user-fullname").value = fullName;
                    editModal.querySelector("#edit-user-img").value = img;
                    editModal.querySelector("#edit-user-email").value = email;
                    editModal.querySelector("#edit-user-phone").value = phone;
                    editModal.querySelector("#location").value = location;
                    editModal.querySelector("#edit-user-specialty").value = specialty;

                    const form = editModal.querySelector("#editTherapistForm");
                    form.setAttribute("action", `/protected/manager/update-therapist/${id}`);
                    form.setAttribute("method", "post");
                });
            });

            // Xử lý nút View Schedule
            const scheduleButtons = document.querySelectorAll(".schedule-btn");
            scheduleButtons.forEach((button) => {
                button.addEventListener("click", function (event) {
                    const scheduleModal = document.querySelector("#viewScheduleModal");
                    const id = event.currentTarget.getAttribute("data-id");
                    const name = event.currentTarget.getAttribute("data-name");

                    // Hiển thị tên chuyên viên trong modal
                    document.querySelector("#therapistName").textContent = name;

                    // Gán ID cho form tạo lịch
                    scheduleModal.querySelector("#createTherapistId").value = id;

                    // Gọi API để lấy lịch làm việc
                    fetch(`/protected/manager/therapists/${id}/schedules/current`)
                        .then(response => {
                            console.log("Response status:", response.status);
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Data from API:", data);
                            const tableBody = document.querySelector("#scheduleTableBody");
                            tableBody.innerHTML = ''; // Xóa nội dung cũ

                            if (!data || data.length === 0) {
                                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Chưa có lịch làm việc.</td></tr>';
                            } else {
                                data.forEach(schedule => {
                                    const row = `
                                    <tr>
                                        <td>${schedule.id}</td>
                                        <td>${schedule.dayOfWeek}</td>
                                        <td>${schedule.startTime.length > 5 ? schedule.startTime.substring(0, 5) : schedule.startTime}</td>
                                        <td>${schedule.endTime.length > 5 ? schedule.endTime.substring(0, 5) : schedule.endTime}</td>
                                        <td>
                                            <a class="btn btn-sm btn-warning edit-schedule-btn"
                                               data-bs-toggle="modal"
                                               data-bs-target="#editScheduleModal"
                                               data-id="${schedule.id}"
                                               data-therapist-id="${id}"
                                               data-day="${schedule.dayOfWeek}"
                                               data-start="${schedule.startTime.length > 5 ? schedule.startTime.substring(0, 5) : schedule.startTime}"
                                               data-end="${schedule.endTime.length > 5 ? schedule.endTime.substring(0, 5) : schedule.endTime}">
                                                <i class="bx bx-edit"></i>
                                            </a>
                                            <a class="btn btn-sm btn-danger delete-schedule-btn"
                                               data-id="${schedule.id}"
                                               data-therapist-id="${id}">
                                                <i class="bx bx-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                `;
                                    tableBody.innerHTML += row;
                                });
                            }

                            // Thêm sự kiện cho các nút Edit Schedule
                            const editScheduleButtons = document.querySelectorAll(".edit-schedule-btn");
                            editScheduleButtons.forEach(btn => {
                                btn.addEventListener("click", function (event) {
                                    const editScheduleModal = document.querySelector("#editScheduleModal");
                                    const id = event.currentTarget.getAttribute("data-id");
                                    const therapistId = event.currentTarget.getAttribute("data-therapist-id");
                                    const day = event.currentTarget.getAttribute("data-day");
                                    const start = event.currentTarget.getAttribute("data-start");
                                    const end = event.currentTarget.getAttribute("data-end");

                                    editScheduleModal.querySelector("#editScheduleId").value = id;
                                    editScheduleModal.querySelector("#editTherapistId").value = therapistId;
                                    editScheduleModal.querySelector("#editScheduleDay").value = day;
                                    editScheduleModal.querySelector("#editScheduleStartTime").value = start;
                                    editScheduleModal.querySelector("#editScheduleEndTime").value = end;

                                    const form = editScheduleModal.querySelector("#editScheduleForm");
                                    form.setAttribute("action", `/protected/manager/therapists/schedules/update/${id}`);
                                    form.setAttribute("method", "post");
                                });
                            });

                            // Thêm sự kiện cho các nút Delete Schedule
                            const deleteScheduleButtons = document.querySelectorAll(".delete-schedule-btn");
                            deleteScheduleButtons.forEach((button) => {
                                button.addEventListener("click", function (event) {
                                    event.preventDefault(); // Ngăn hành vi mặc định của thẻ <a>

                                    const scheduleId = event.currentTarget.getAttribute("data-id");
                                    const therapistId = event.currentTarget.getAttribute("data-therapist-id");

                                    // Hiển thị xác nhận trước khi xóa
                                    if (!confirm("Are you sure you want to delete this schedule?")) {
                                        return;
                                    }

                                    // Gửi yêu cầu DELETE qua fetch
                                    fetch(`/protected/manager/therapists/schedules/delete/${scheduleId}`, {
                                        method: "DELETE",
                                        headers: {
                                            "Content-Type": "application/json"
                                        }
                                    })
                                        .then(response => {
                                            console.log("Delete response status:", response.status); // Log để kiểm tra phản hồi
                                            if (response.ok) {
                                                const successMessage = document.querySelector("#scheduleSuccessMessage");
                                                const successText = document.querySelector("#scheduleSuccessText");
                                                successText.textContent = "Lịch làm việc đã được xóa thành công!";
                                                successMessage.classList.remove("d-none");

                                                // Cập nhật lại bảng lịch
                                                scheduleButtons.forEach(btn => {
                                                    if (btn.getAttribute("data-id") === therapistId) {
                                                        btn.click(); // Gọi lại API để tải lại lịch
                                                    }
                                                });
                                            } else {
                                                return response.text().then(text => { throw new Error(text); });
                                            }
                                        })
                                        .catch(error => {
                                            console.error("Lỗi khi xóa lịch:", error); // Log lỗi
                                            const errorMessage = document.querySelector("#scheduleErrorMessage");
                                            const errorText = document.querySelector("#scheduleErrorText");
                                            errorText.textContent = error.message || "Không thể xóa lịch làm việc.";
                                            errorMessage.classList.remove("d-none");
                                        });
                                });
                            });
                        })
                        .catch(error => {
                            console.error("Lỗi khi lấy lịch làm việc:", error);
                            const tableBody = document.querySelector("#scheduleTableBody");
                            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Lỗi khi tải lịch làm việc.</td></tr>';
                        });

                    // Xử lý form tạo lịch
                    const createForm = scheduleModal.querySelector("#createScheduleForm");
                    createForm.addEventListener("submit", function (event) {
                        event.preventDefault();
                        const submitButton = createForm.querySelector("button[type='submit']");
                        submitButton.disabled = true; // Vô hiệu hóa nút để tránh gửi trùng lặp

                        const formData = new FormData(createForm);
                        const data = Object.fromEntries(formData);

                        fetch(`/protected/manager/therapists/${id}/schedules`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(data)
                        })
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                } else {
                                    return response.text().then(text => { throw new Error(text); });
                                }
                            })
                            .then(data => {
                                const successMessage = document.querySelector("#scheduleSuccessMessage");
                                const successText = document.querySelector("#scheduleSuccessText");
                                successText.textContent = "Lịch làm việc đã được tạo thành công!";
                                successMessage.classList.remove("d-none");

                                // Reset form và kích hoạt lại nút
                                createForm.reset();
                                submitButton.disabled = false;

                                // Cập nhật lại bảng lịch
                                scheduleButtons.forEach(btn => {
                                    if (btn.getAttribute("data-id") === id) {
                                        btn.click();
                                    }
                                });
                            })
                            .catch(error => {
                                const errorMessage = document.querySelector("#scheduleErrorMessage");
                                const errorText = document.querySelector("#scheduleErrorText");
                                errorText.textContent = error.message || "Không thể tạo lịch làm việc.";
                                errorMessage.classList.remove("d-none");
                            });
                    });
                });
            });

            // Xử lý form chỉnh sửa lịch
            const editScheduleForm = document.querySelector("#editScheduleForm");
            editScheduleForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const formData = new FormData(editScheduleForm);
                const data = Object.fromEntries(formData);

                fetch(`/protected/manager/therapists/schedules/update/${data.scheduleId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            return response.text().then(text => { throw new Error(text); });
                        }
                    })
                    .then(data => {
                        const successMessage = document.querySelector("#scheduleSuccessMessage");
                        const successText = document.querySelector("#scheduleSuccessText");
                        successText.textContent = "Lịch làm việc đã được cập nhật thành công!";
                        successMessage.classList.remove("d-none");

                        // Đóng modal chỉnh sửa
                        const editModal = document.querySelector("#editScheduleModal");
                        const modalInstance = bootstrap.Modal.getInstance(editModal);
                        modalInstance.hide();

                        // Cập nhật lại bảng lịch
                        scheduleButtons.forEach(btn => {
                            if (btn.getAttribute("data-id") === data.therapistId) {
                                btn.click();
                            }
                        });
                    })
                    .catch(error => {
                        const errorMessage = document.querySelector("#scheduleErrorMessage");
                        const errorText = document.querySelector("#scheduleErrorText");
                        errorText.textContent = error.message || "Không thể cập nhật lịch làm việc.";
                        errorMessage.classList.remove("d-none");
                    });
            });
        });
    </script>
</body>
</html>