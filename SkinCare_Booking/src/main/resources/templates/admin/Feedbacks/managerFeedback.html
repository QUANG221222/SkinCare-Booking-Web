<!doctype html>
<html lang="en" class="layout-menu-fixed layout-compact" data-assets-path="/admin/assets/" data-template="vertical-menu-template-free" xmlns:th="http://www.thymeleaf.org">
<!-- Head -->
<div th:replace="admin/fragments/head :: head"></div>

<body>
<!-- Layout wrapper -->
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <!-- Menu -->
        <div th:replace="admin/fragments/menu :: menu"></div>
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
            <!-- Navbar -->
            <nav class="layout-navbar container-xxl navbar-detached navbar navbar-expand-xl align-items-center bg-navbar-theme" id="layout-navbar">
                <div class="layout-menu-toggle navbar-nav align-items-xl-center me-4 me-xl-0 d-xl-none">
                    <a class="nav-item nav-link px-0 me-xl-6" href="javascript:void(0)">
                        <i class="icon-base bx bx-menu icon-md"></i>
                    </a>
                </div>

                <div class="navbar-nav-right d-flex align-items-center justify-content-end" id="navbar-collapse">
                    <ul class="navbar-nav flex-row align-items-center ms-md-auto">
                        <!-- User -->
                        <div th:replace="admin/fragments/user :: user"></div>
                        <!--/ User -->
                    </ul>
                </div>
            </nav>
            <!-- / Navbar -->

            <!-- Content wrapper -->
            <div class="content-wrapper">
                <!-- Content -->
                <div class="container-xxl flex-grow-1 container-p-y">
                    <!-- Feedback List Table -->
                    <div class="card">
                        <div class="row mx-3 my-0 justify-content-between">
                            <div class="py-3 d-flex align-items-center justify-content-between flex-wrap gap-3">
                                <h5 class="mb-0">Feedback List</h5>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <div class="container mt-3">
                                <!-- Alert for Success -->
                                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show position-relative" role="alert">
                                    <span th:text="${successMessage}"></span>
                                </div>

                                <!-- Alert for Error -->
                                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show position-relative" role="alert">
                                    <span th:text="${errorMessage}"></span>
                                </div>
                            </div>
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                <tr>
                                    <th style="width: 11%;">Subject</th>
                                    <th style="width: 27%;">Message</th>
                                    <th style="width: 15%;">Rating</th>
                                    <th style="width: 15%;">Customer</th>
                                    <th style="width: 15%;">Date</th>
                                    <th style="width: 7%;">Status</th>
                                    <th style="width: 10%;">Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="feedback : ${feedbackList}">
                                    <td th:text="${feedback.subject}"></td>
                                    <td th:text="${feedback.message}"></td>
                                    <td>
                                        <div class="star-rating">
                                                <span th:each="i : ${#numbers.sequence(1, 5)}"
                                                      th:classappend="${i <= feedback.rating} ? 'fas fa-star text-warning' : 'far fa-star text-muted'"></span>
                                        </div>
                                    </td>
                                    <td th:text="${feedback.username}"></td>
                                    <td th:text="${#temporals.format(feedback.createdAt, 'yyyy/MM/dd HH:mm')}"></td>
                                    <td>
                                        <span th:if="${feedback.isHidden}" class="badge bg-danger">Hidden</span>
                                        <span th:unless="${feedback.isHidden}" class="badge bg-success">Visible</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger delete-btn" th:data-id="${feedback.id}">
                                            <i class="bx bx-trash me-1"></i> Delete
                                        </button>
                                        <button class="btn btn-sm btn-warning hide-btn" th:unless="${feedback.isHidden}" th:data-id="${feedback.id}">
                                            <i class="bx bx-hide me-1"></i> Hide
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(feedbackList)}">
                                    <td colspan="7" class="text-center">No feedbacks found.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Modal Confirm Delete Feedback -->
                    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Are you sure you want to delete this feedback permanently?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Confirm Hide Feedback -->
                    <div class="modal fade" id="hideConfirmModal" tabindex="-1" aria-labelledby="hideConfirmModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="hideConfirmModalLabel">Confirm Hide</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Are you sure you want to hide this feedback?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-warning" id="confirmHideButton">Hide</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- / Content -->
            </div>
            <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>
    <!-- / Layout wrapper -->

    <!-- Core JS -->
    <div th:replace="admin/fragments/script :: script"></div>

    <!-- JavaScript for Delete and Hide Actions -->
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script>
        $(document).ready(function () {
            // Delete button click
            $('.delete-btn').click(function () {
                const id = $(this).data('id');
                const row = $(this).closest('tr');
                $('#deleteConfirmModal').modal('show');
                $('#confirmDeleteButton').off('click').on('click', function () {
                    $.ajax({
                        url: '/api/feedbacks/' + id + '?permanent=true',
                        type: 'DELETE',
                        success: function (response) {
                            row.remove();
                            $('#deleteConfirmModal').modal('hide');
                            alert('Feedback deleted successfully!');
                            if ($('#feedbackTable tbody tr').length === 0) {
                                $('#feedbackTable tbody').append('<tr><td colspan="7" class="text-center">No feedbacks found.</td></tr>');
                            }
                        },
                        error: function (xhr) {
                            alert('Error deleting feedback: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
                            $('#deleteConfirmModal').modal('hide');
                        }
                    });
                });
            });

            // Hide button click
            $('.hide-btn').click(function () {
                const id = $(this).data('id');
                const row = $(this).closest('tr');
                $('#hideConfirmModal').modal('show');
                $('#confirmHideButton').off('click').on('click', function () {
                    $.ajax({
                        url: '/api/feedbacks/' + id + '?permanent=false',
                        type: 'DELETE',
                        success: function (response) {
                            row.find('td:eq(5)').html('<span class="badge bg-danger">Hidden</span>');
                            row.find('.hide-btn').remove();
                            $('#hideConfirmModal').modal('hide');
                            alert('Feedback hidden successfully!');
                        },
                        error: function (xhr) {
                            alert('Error hiding feedback: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
                            $('#hideConfirmModal').modal('hide');
                        }
                    });
                });
            });
        });
    </script>

    <!-- CSS for Star Rating and Table Layout -->
    <style>
        .star-rating .fas.fa-star {
            color: #ffd700; /* Màu vàng cho ngôi sao đầy */
        }
        .star-rating .far.fa-star {
            color: #ccc; /* Màu xám cho ngôi sao rỗng */
        }
        /* Đảm bảo bảng chiếm toàn bộ chiều rộng */
        .table-responsive {
            overflow-x: auto;
        }
        .table {
            width: 100%;
            table-layout: fixed; /* Đảm bảo các cột có chiều rộng cố định */
        }
        /* Điều chỉnh khoảng cách giữa các hàng */
        .table tbody tr {
            height: 50px; /* Chiều cao cố định cho mỗi hàng */
            vertical-align: middle; /* Căn giữa nội dung hàng */
        }
        /* Điều chỉnh padding trong ô */
        .table td, .table th {
            padding: 8px; /* Khoảng cách bên trong ô */
            text-align: center; /* Căn giữa nội dung */
        }
        /* Điều chỉnh kích thước nút trong cột Actions */
        .table .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</body>
</html>